<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ملف المستفيد</title>
  <!-- Bootstrap RTL (consistent with system pages) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="/public/app.css" rel="stylesheet">
  <link href="/public/moe-ui.css" rel="stylesheet">
    <style>
    .beneficiary-page .ui-container{max-width:1200px}
    .beneficiary-page .btn.btn-lg{padding:.7rem 1.1rem; font-size:1.05rem}

    .print-header{display:none; gap:12px; align-items:center; justify-content:space-between; margin:0 0 12px 0}
    .print-header .title{font-size:18pt; font-weight:800}
    .print-meta{display:flex; gap:14px; flex-wrap:wrap; font-size:11pt}
    .print-meta .item{min-width:180px}
    .print-meta .lbl{color:#666; font-size:10pt}

    @media print{
      @page{ size: A4; margin: 12mm; }
      .no-print{display:none !important}
      body{
        background:#fff !important;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
        font-family: var(--ui-font, "Tajawal", Arial, sans-serif) !important;
      }
      html[dir="rtl"] body{direction:rtl}
      .ui-nav{display:none !important}
      .ui-container{max-width:100% !important; padding:0 !important; margin:0 !important}
      .ui-card{box-shadow:none !important; border:1px solid #e5e5e5 !important; padding:14px !important}
      .print-header{display:flex !important}
      hr{opacity:1}
      h3,h4,h5{break-after:avoid}
      .row{break-inside:avoid}
      .table-responsive{overflow:visible !important}
      table{font-size:11pt; width:100% !important}
      .table{border-collapse:collapse !important}
      .table>:not(caption)>*>*{padding:7px 9px !important}
      .table-striped>tbody>tr:nth-of-type(odd)>*{background-color:transparent !important}
      .table th,.table td{border:1px solid #d9d9d9 !important; vertical-align:top}
      .badge,.ui-pill{border:1px solid #bbb !important}
    }
  </style>
</head>
<body class="beneficiary-page">
<div class="ui-container">
  <%- include('partials_nav', {user:user}) %>

  <div class="ui-card mt-3">
    <div class="print-header">
      <div>
        <div class="title">ملف المستفيد</div>
        <div class="text-muted">تاريخ الطباعة: <%= (new Date()).toLocaleString('ar-SA') %></div>
      </div>
    </div>

    <!-- Premium Header -->
    <div class="p-3 p-md-4 rounded-4" style="background:linear-gradient(135deg, rgba(0,120,90,.14), rgba(0,40,90,.10)); border:1px solid rgba(0,0,0,.06)">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div class="d-flex align-items-center gap-3">
          <% const initials = (profile.full_name||'م').trim().slice(0,1) || 'م'; %>
          <div style="width:58px;height:58px;border-radius:18px;background:linear-gradient(180deg,#12a070,#0b5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:22px;box-shadow:0 14px 30px rgba(0,0,0,.14)">
            <%= initials %>
          </div>
          <div>
            <div class="small text-muted">ملف المستفيد</div>
            <div class="h4 fw-bold mb-1"><%= profile.full_name || '—' %></div>
            <div class="d-flex flex-wrap gap-2">
              <span class="ui-pill" style="border:1px solid rgba(0,0,0,.10)">هوية: <span class="fw-bold"><%= profile.national_id || '—' %></span></span>
              <span class="ui-pill" style="border:1px solid rgba(0,0,0,.10)">جوال: <span class="fw-bold"><%= profile.phone || '—' %></span></span>
            </div>
          </div>
        </div>

        <div class="no-print d-flex flex-wrap gap-2">
          <a class="btn btn-outline-secondary btn-lg" href="<%= backUrl %>">رجوع</a>
          <button class="btn btn-primary btn-lg" onclick="printWithOrientation('landscape')">طباعة</button>
        </div>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="mt-3">
      <div class="row g-2 g-md-3">
        <div class="col-12 col-md-3">
          <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
            <div class="small text-muted">إجمالي الطلبات</div>
            <div class="h3 fw-bold mb-0"><%= (summary && summary.total_tickets!=null) ? summary.total_tickets : (tickets ? tickets.length : 0) %></div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
            <div class="small text-muted">المغلقة</div>
            <div class="h3 fw-bold mb-0"><%= (summary && summary.closed_tickets!=null) ? summary.closed_tickets : 0 %></div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
            <div class="small text-muted">آخر كونتر</div>
            <div class="h5 fw-bold mb-0"><%= (summary && summary.last_counter) ? summary.last_counter : '—' %></div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
            <div class="small text-muted">آخر موظف</div>
            <div class="h5 fw-bold mb-0"><%= (summary && summary.last_employee) ? summary.last_employee : '—' %></div>
          </div>
        </div>
      </div>

      <% if (summary && summary.ratings_count && summary.avg_rating!=null) { %>
        <div class="mt-2 d-flex flex-wrap gap-2 align-items-center">
          <span class="small text-muted">متوسط التقييم:</span>
          <span class="badge bg-primary"><%= summary.avg_rating.toFixed(2) %>/5</span>
          <span class="text-muted small">(عدد التقييمات: <%= summary.ratings_count %>)</span>
        </div>
      <% } %>
    </div>

    <!-- Tabs -->
    <div class="mt-4">
      <ul class="nav nav-pills gap-2 no-print" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-overview" data-bs-toggle="pill" data-bs-target="#pane-overview" type="button" role="tab">ملخص</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-history" data-bs-toggle="pill" data-bs-target="#pane-history" type="button" role="tab">سجل الحالات</button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="pane-overview" role="tabpanel">
          <% const last = tickets && tickets.length ? tickets[0] : null; %>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
                <div class="fw-bold mb-2">آخر طلب</div>
                <% if (!last) { %>
                  <div class="text-muted">لا توجد بيانات.</div>
                <% } else { %>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-dark"># <%= last.ticket_code %></span>
                    <span class="badge bg-info text-dark"><%= last.service_name_ar || last.service_name || '-' %></span>
                    <span class="badge bg-secondary"><%= last.counter_name || '-' %></span>
                    <span class="badge bg-secondary"><%= last.employee_name || '-' %></span>
                    <% if (String(last.status||'').toUpperCase().includes('CLOSED')) { %>
                      <span class="badge bg-success">مغلقة</span>
                    <% } else { %>
                      <span class="badge bg-warning text-dark">جارية</span>
                    <% } %>
                  </div>
                  <div class="mt-2 small text-muted">إنشاء: <%= last.created_at ? (new Date(last.created_at)).toLocaleString('ar-SA') : '-' %> • إغلاق: <%= last.closed_at ? (new Date(last.closed_at)).toLocaleString('ar-SA') : '-' %></div>
                  <% const s = (last.case_summary || last.summary || '').trim(); const d = (last.case_details || '').trim(); %>
                  <div class="mt-3">
                    <div class="fw-bold">ملخص الحالة</div>
                    <div class="mt-1" style="white-space:pre-wrap"><%= (s || d) ? (s || '—') : '—' %></div>
                    <% if (d) { %><div class="small text-muted mt-2" style="white-space:pre-wrap"><%= d %></div><% } %>
                  </div>
                <% } %>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="p-3 rounded-4" style="border:1px solid rgba(0,0,0,.06); background:#fff">
                <div class="fw-bold mb-2">آخر تقييم</div>
                <% if (!last_feedback) { %>
                  <div class="text-muted">لا يوجد تقييم مسجل.</div>
                <% } else { %>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-primary">تقييم الموظف: <%= last_feedback.employee_rating %>/5</span>
                    <span class="badge <%= last_feedback.solved_yes_no ? 'bg-success' : 'bg-danger' %>"><%= last_feedback.solved_yes_no ? 'تم الحل' : 'لم يتم الحل' %></span>
                    <span class="badge bg-light text-dark" style="border:1px solid rgba(0,0,0,.08)"><%= last_feedback.created_at ? (new Date(last_feedback.created_at)).toLocaleString('ar-SA') : '' %></span>
                  </div>
                  <% if (last_feedback.comment) { %>
                    <div class="mt-3">
                      <div class="fw-bold">ملاحظة المستفيد</div>
                      <div class="mt-1" style="white-space:pre-wrap"><%= last_feedback.comment %></div>
                    </div>
                  <% } %>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-history" role="tabpanel">
          <% if (!tickets.length) { %>
            <div class="alert alert-warning">لا توجد حالات سابقة لهذا المستفيد.</div>
          <% } else { %>
            <div class="table-responsive">
              <table class="table table-hover align-middle" style="border:1px solid rgba(0,0,0,.06)">
                <thead style="background:rgba(0,0,0,.03)">
                  <tr>
                    <th>التذكرة</th>
                    <th>الخدمة</th>
                    <th>الكونتر</th>
                    <th>الموظف</th>
                    <th>الحالة</th>
                    <th>التقييم</th>
                    <th>إنشاء</th>
                    <th>إغلاق</th>
                    <th style="min-width:320px">ملخص الحالة</th>
                  </tr>
                </thead>
                <tbody>
                  <% tickets.forEach(t=>{ %>
                    <tr>
                      <td class="fw-bold"><%= t.ticket_code %></td>
                      <td><%= t.service_name_ar || t.service_name || '-' %></td>
                      <td><%= t.counter_name || '-' %></td>
                      <td><%= t.employee_name || '-' %></td>
                      <td>
                        <% if (String(t.status||'').toUpperCase().includes('CLOSED')) { %>
                          <span class="badge bg-success">مغلقة</span>
                        <% } else if (['IN_SERVICE','CALLED','ASSIGNED','NEW'].includes(String(t.status||''))) { %>
                          <span class="badge bg-warning text-dark">جارية</span>
                        <% } else { %>
                          <span class="badge bg-secondary"><%= t.status %></span>
                        <% } %>
                      </td>
                      <td>
                        <% if (t.feedback) { %>
                          <span class="badge bg-primary"><%= t.feedback.employee_rating %>/5</span>
                          <span class="badge <%= t.feedback.solved_yes_no ? 'bg-success' : 'bg-danger' %>"><%= t.feedback.solved_yes_no ? 'تم الحل' : 'لم يتم الحل' %></span>
                        <% } else { %>
                          <span class="text-muted">-</span>
                        <% } %>
                      </td>
                      <td class="small"><%= t.created_at ? (new Date(t.created_at)).toLocaleString('ar-SA') : '-' %></td>
                      <td class="small"><%= t.closed_at ? (new Date(t.closed_at)).toLocaleString('ar-SA') : '-' %></td>
                      <td style="white-space:pre-wrap">
                        <% const s = (t.case_summary || t.summary || '').trim(); const d = (t.case_details || '').trim(); %>
                        <% if (s || d) { %>
                          <div class="fw-bold"><%= s || '—' %></div>
                          <% if (d) { %><div class="small text-muted mt-1"><%= d %></div><% } %>
                        <% } else { %>
                          <span class="text-muted">—</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  // Print orientation control (works offline)
  let styleEl = null;
  window.printWithOrientation = function(orientation){
    try{
      if (!styleEl){
        styleEl = document.createElement('style');
        styleEl.setAttribute('data-print-orientation','1');
        document.head.appendChild(styleEl);
      }
      const o = (orientation === 'portrait') ? 'A4 portrait' : 'A4 landscape';
      styleEl.textContent = '@media print{ @page{ size: ' + o + '; margin: 12mm; } }';
    }catch(e){}
    window.print();
  };
})();
</script>

<script>
// Lightweight tabs (no dependency) — keeps the page offline-safe
(function(){
  const btns = [
    {btn:'tab-overview', pane:'pane-overview'},
    {btn:'tab-history', pane:'pane-history'}
  ];
  function activate(id){
    btns.forEach(x=>{
      const b = document.getElementById(x.btn);
      const p = document.getElementById(x.pane);
      if (!b || !p) return;
      const on = (x.btn === id);
      b.classList.toggle('active', on);
      p.classList.toggle('show', on);
      p.classList.toggle('active', on);
    });
  }
  btns.forEach(x=>{
    const b = document.getElementById(x.btn);
    if (!b) return;
    b.addEventListener('click', (e)=>{ e.preventDefault(); activate(x.btn); });
  });
})();
</script>

</body>
</html>
