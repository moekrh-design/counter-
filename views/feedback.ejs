<!doctype html>
<%
  // Keep translations as plain strings only (no nested EJS inside this block)
  const TT_FB = {
    ar:{title:"التقييم", dir:"rtl", refresh:"تحديث", orgName:(branding && branding.org_name_ar)||"وزارة التعليم", orgSub:(branding && branding.kiosk_subtitle_ar)||"نقدّر وقتك… شاركنا رأيك", noNow:"لا توجد جلسة تقييم حالياً", pleaseWait:"يرجى الانتظار…", yourTicket:"رقم تذكرتك", yes:"نعم", no:"لا", tapChoose:"اضغط لاختيار الإجابة", rateHint:"اختر تقييمك — سيتم الإرسال تلقائياً", back:"رجوع", q1:"هل تم إنجاز طلبك؟", q2:"قيّم خدمة الموظف"},
    en:{title:"Feedback", dir:"ltr", refresh:"Refresh", orgName:(branding && branding.org_name_en)||"Ministry of Education", orgSub:(branding && branding.kiosk_subtitle_en)||"We value your time… share your feedback", noNow:"No feedback session right now", pleaseWait:"Please wait…", yourTicket:"Your ticket number", yes:"Yes", no:"No", tapChoose:"Tap to choose", rateHint:"Choose your rating — it will be submitted automatically", back:"Back", q1:"Was your request completed?", q2:"Rate the employee service"},
    fr:{title:"Avis", dir:"ltr", refresh:"Actualiser", orgName:(branding && branding.org_name_fr)|| (branding && branding.org_name_en)||"Ministry of Education", orgSub:(branding && branding.kiosk_subtitle_fr)||"Nous apprécions votre temps… partagez votre avis", noNow:"Aucune évaluation en cours", pleaseWait:"Veuillez patienter…", yourTicket:"Votre numéro de ticket", yes:"Oui", no:"Non", tapChoose:"Appuyez pour choisir", rateHint:"Choisissez votre note — envoi automatique", back:"Retour", q1:"Votre demande a-t-elle été traitée ?", q2:"Évaluez le service de l'agent"},
    zh:{title:"评价", dir:"ltr", refresh:"刷新", orgName:(branding && branding.org_name_zh)|| (branding && branding.org_name_en)||"Ministry of Education", orgSub:(branding && branding.kiosk_subtitle_zh)||"感谢您的时间…欢迎评价", noNow:"当前暂无评价", pleaseWait:"请稍候…", yourTicket:"您的票号", yes:"是", no:"否", tapChoose:"点击选择", rateHint:"请选择评分（将自动提交）", back:"返回", q1:"您的需求是否已完成？", q2:"请为员工服务评分"}
  };
  const L = (typeof lang !== 'undefined' && lang) ? lang : 'ar';
  const tr = TT_FB[L] || TT_FB.ar;
  const hasTicket = !!ticket;
  // Server-side safe (no window object)
  const counterId = (counter && counter.id) ? counter.id : '';
%>
<html lang="<%= L %>" dir="<%= tr.dir %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0B2530">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title><%= tr.title %></title>
  <link rel="manifest" href="/public/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/public/icon-192.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/public/app.css" rel="stylesheet">
  <link href="/public/moe-ui.css" rel="stylesheet">
</head>

<body class="kiosk-body kiosk-feedback kiosk-scroll" data-theme="<%= (typeof ui !== 'undefined' && ui && ui.theme) ? ui.theme : 'dark' %>">

<div class="kiosk-shell">
  <div class="kiosk-brand-header">
    <div class="kiosk-brand-left">
      <a class="kiosk-ghost-btn" href="/feedback" title="<%= tr.refresh %>">↻</a>
    </div>
    <div class="kiosk-brand-center">
      <div class="kiosk-brand-title"><%= tr.orgName %></div>
      <div class="kiosk-brand-sub"><%= tr.orgSub %></div>
    </div>
    <div class="kiosk-brand-right">
      <% if (branding && branding.logo_url){ %>
        <img class="kiosk-brand-logo" src="<%= branding.logo_url %>" alt="logo">
      <% } %>
    </div>
  </div>

  <div class="kiosk-stage">
    <div class="kiosk-card kiosk-card-hero" style="max-width:none; width:100%; border-radius:0; margin:0; min-height: 100%; height: 100%;">

	      <% if (!ticket){ %>
        <div class="text-center">
          <div class="display-6 fw-bold mb-2"><%= tr.noNow %></div>
          <div class="muted"><%= tr.pleaseWait %></div>
        </div>
      <% } else { %>
        <div class="text-center">
          <div class="kiosk-step-title"><%= tr.yourTicket %></div>
          <div class="kiosk-ticket-code mt-2"><%= ticket.ticket_code %></div>
          <div class="muted mt-2">
            <span class="badge text-bg-secondary"><%= counter ? counter.name : (counterId ? ('كونتر ' + counterId) : '—') %></span>
            <span class="badge text-bg-secondary"><%= employee ? employee.full_name : '—' %></span>
          </div>
        </div>

        <hr class="my-4"/>

        <form id="fbForm" method="post" action="/feedback/submit">
          <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
          <input type="hidden" name="counter_id" id="counter_id" value="<%= counterId %>">
          <input type="hidden" id="solved_yes_no" name="solved_yes_no" value="">
          <input type="hidden" id="employee_rating" name="employee_rating" value="">
          <input type="hidden" id="reason_code" name="reason_code" value="">

          <!-- Step 1 -->
          <div id="step1" class="text-center">
	            <div class="kiosk-step-title"><%= (L==='ar' && (typeof q1 !== 'undefined') && q1) ? q1 : tr.q1 %></div>
            <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
              <button type="button" class="btn btn-success btn-lg px-5 py-3" data-solved="true"><%= tr.yes %></button>
              <button type="button" class="btn btn-danger btn-lg px-5 py-3" data-solved="false"><%= tr.no %></button>
            </div>
            <div class="muted mt-4"><%= tr.tapChoose %></div>
          </div>

          <!-- Step 2 -->
          <div id="step2" class="text-center d-none">
	            <div class="kiosk-step-title"><%= (L==='ar' && (typeof q2 !== 'undefined') && q2) ? q2 : tr.q2 %></div>
            <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
              <% for(let i=1;i<=5;i++){ %>
                <button type="button" class="btn btn-outline-warning btn-lg px-4 py-3 star-btn" data-rate="<%= i %>">
                  <span style="font-size: 34px;">⭐</span>
                  <div class="fw-bold mt-1" style="font-size: 18px;"><%= i %></div>
                </button>
              <% } %>
            </div>
            <div id="rateHint" class="muted mt-4"><%= tr.rateHint %></div>

            <div class="d-flex justify-content-center mt-4">
              <button type="button" class="btn btn-outline-light btn-lg px-4" data-back="1"><%= tr.back %></button>
            </div>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</div>

<script>
  // iOS: stable 100vh (Safari address bar) + try to reduce top bars.
  function setVh(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVh();
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', ()=>setTimeout(setVh, 150));

  // Best-effort: hide Safari bar a bit (works only in-browser; PWA is true standalone).
  window.addEventListener('load', ()=>{
    setTimeout(()=>{ try{ window.scrollTo(0,1); }catch(e){} }, 60);
  });

  // PWA installability: register SW (no caching).
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('/public/sw.js').catch(()=>{});
  }

  function pickSolved(v){
    document.getElementById('solved_yes_no').value = String(!!v);
    document.getElementById('step1').classList.add('d-none');
    document.getElementById('step2').classList.remove('d-none');
  }
  function backToStep1(){
    document.getElementById('step2').classList.add('d-none');
    document.getElementById('step1').classList.remove('d-none');
    document.getElementById('employee_rating').value = '';
    document.querySelectorAll('.star-btn').forEach(b=>b.classList.remove('active'));
  }
  function pickRate(n){
    document.getElementById('employee_rating').value = String(n);
    document.querySelectorAll('.star-btn').forEach(b=>{
      b.classList.toggle('active', Number(b.getAttribute('data-rate'))===n);
    });
    // submit after short delay so user sees selection
    setTimeout(()=>{
      const form = document.getElementById('fbForm');
      if (form.requestSubmit) form.requestSubmit();
      else form.submit();
    }, 250);
  }

  // iPad/iOS: reliable "tap" handling (touchend + click) with double-fire guard.
  let lastTapAt = 0;
  function bindTap(el, fn){
    const handler = (e)=>{
      const now = Date.now();
      if (e && e.type === 'click' && (now - lastTapAt) < 450) return;
      if (e && e.type === 'touchend') lastTapAt = now;
      try{ e.preventDefault(); }catch(_e){}
      try{ e.stopPropagation(); }catch(_e){}
      fn();
    };
    el.style.touchAction = 'manipulation';
    el.addEventListener('touchend', handler, {passive:false});
    el.addEventListener('click', handler, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('[data-solved]').forEach(btn=>{
      bindTap(btn, ()=> pickSolved(btn.getAttribute('data-solved')==='true'));
    });
    document.querySelectorAll('[data-rate]').forEach(btn=>{
      bindTap(btn, ()=> pickRate(Number(btn.getAttribute('data-rate'))));
    });
    document.querySelectorAll('[data-back]').forEach(btn=>{
      bindTap(btn, ()=> backToStep1());
    });
  });

  // Auto-update (poll): refresh page when feedback window changes/ends.
  const HAS_TICKET = <%= hasTicket ? 'true' : 'false' %>;
  const COUNTER_ID = "<%= String(counterId || '') %>";
  const CURRENT_TICKET_ID = "<%= ticket ? String(ticket.id) : '' %>";
  async function pollWindow(){
    try{
      const url = '/api/feedback/current' + (COUNTER_ID ? ('?counter_id=' + encodeURIComponent(COUNTER_ID)) : '');
      const r = await fetch(url, {cache:'no-store'});
      const j = await r.json();
      const w = j && j.window;
      if (!w){
        if (HAS_TICKET) location.reload();
        return;
      }
      // If a window starts while we're showing the waiting screen, refresh immediately.
      if (!HAS_TICKET && w) {
        location.reload();
        return;
      }
      if (String(w.ticket_id || '') !== CURRENT_TICKET_ID){
        location.reload();
      }
    }catch(e){ /* ignore */ }
  }

  // Always poll: when a window appears/disappears, refresh immediately.
  setInterval(pollWindow, 1500);
  // Fallback refresh in case polling is blocked temporarily.
  setInterval(()=>{ try{ location.reload(); }catch(e){} }, 12000);
</script>

  <script src="/public/pwa-helper.js"></script>
</body>
</html>
